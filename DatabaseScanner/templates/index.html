<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Scanner by ayush1512</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: clamp(1rem, 4vw, 2rem);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .title {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 2rem;
            font-size: clamp(1.5rem, 4vw, 2rem);
            word-wrap: break-word;
        }

        .upload-container {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: clamp(1rem, 3vw, 2rem);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-container:hover {
            border-color: #666;
            background-color: #f8f9fa;
        }

        .upload-icon {
            font-size: clamp(2rem, 5vw, 3rem);
            color: #666;
            margin-bottom: 1rem;
        }

        .upload-container p {
            font-size: clamp(0.875rem, 2vw, 1rem);
            color: #666;
        }

        .image-preview-container {
            max-width: 100%;
            margin: 2rem 0;
            display: none;
            overflow: hidden;
        }

        #image-preview {
            max-width: 100%;
            display: block;
        }

        /* Make cropper more mobile-friendly */
        .cropper-container {
            max-width: 100% !important;
        }

        .cropper-wrap-box {
            background-color: #f8f9fa;
        }

        .buttons {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: clamp(0.5rem, 2vw, 0.75rem) clamp(1rem, 3vw, 1.5rem);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: clamp(0.875rem, 2vw, 1rem);
            width: auto;
            min-width: 120px;
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
            }
        }

        .btn-primary {
            background-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0052a3;
        }

        .btn-primary:disabled {
            background-color: #99c2ff;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .processing {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        .timer {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: clamp(1.25rem, 3vw, 1.5rem);
            height: clamp(1.25rem, 3vw, 1.5rem);
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .results {
            display: none;
            margin-top: 2rem;
            padding: clamp(1rem, 3vw, 1.5rem);
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .results h3 {
            margin-bottom: 1rem;
            color: #1a1a1a;
            font-size: clamp(1.1rem, 2.5vw, 1.25rem);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
            gap: clamp(0.75rem, 2vw, 1rem);
        }

        .result-item {
            padding: clamp(0.75rem, 2vw, 1rem);
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .result-item h4 {
            color: #666;
            margin-bottom: 0.5rem;
            font-size: clamp(0.9rem, 2vw, 1rem);
        }

        .result-item p {
            color: #1a1a1a;
            word-break: break-word;
            font-size: clamp(0.875rem, 2vw, 1rem);
        }

        .error {
            color: #dc3545;
            text-align: center;
            margin: 1rem 0;
            display: none;
            font-size: clamp(0.875rem, 2vw, 1rem);
            padding: 0.75rem;
            background-color: #ffe6e6;
            border-radius: 6px;
        }

        /* Touch device optimizations */
        @media (hover: none) {
            .cropper-point {
                width: 20px;
                height: 20px;
                opacity: 0.9;
            }

            .cropper-line {
                height: 2px;
                width: 2px;
            }
        }

        /* Small screen adjustments */
        @media (max-width: 480px) {
            body {
                padding: 0.5rem;
            }

            .container {
                padding: 1rem;
                border-radius: 8px;
            }

            .buttons {
                flex-direction: column;
                gap: 0.75rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Medium screen adjustments */
        @media (min-width: 481px) and (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Print styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .container {
                box-shadow: none;
                padding: 0;
            }

            .upload-container,
            .buttons,
            .processing {
                display: none;
            }

            .results {
                break-inside: avoid;
                background: none;
                padding: 0;
            }

            .result-item {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #fff;
            }

            .container {
                background: #2d2d2d;
            }

            .title {
                color: #fff;
            }

            .upload-container {
                border-color: #444;
            }

            .upload-container:hover {
                background-color: #363636;
                border-color: #666;
            }

            .upload-icon,
            .upload-container p {
                color: #ccc;
            }

            .results {
                background-color: #363636;
            }

            .result-item {
                background: #2d2d2d;
            }

            .result-item h4 {
                color: #ccc;
            }

            .result-item p {
                color: #fff;
            }

            .timer {
                color: #ccc;
            }

            .error {
                background-color: #442326;
            }
        }

        /* High contrast mode support */
        @media (forced-colors: active) {
            .btn {
                border: 1px solid ButtonText;
            }

            .upload-container {
                border: 2px dashed ButtonText;
            }

            .result-item {
                border: 1px solid ButtonText;
            }
        }

        .mode-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-toggle.dark {
            background: #444;
        }

        .mode-toggle .icon {
            font-size: 1.5rem;
        }

        .mode-toggle .icon.sun {
            display: none;
        }

        .mode-toggle.dark .icon.sun {
            display: inline;
        }

        .mode-toggle.dark .icon.moon {
            display: none;
        }

        body.light-mode .mode-toggle .icon.sun {
            display: none;
        }

        body.light-mode .mode-toggle .icon.moon {
            display: inline;
        }

        body.light-mode {
            background-color: #f0f2f5;
            color: #1a1a1a;
        }

        body.light-mode .container {
            background: white;
        }

        body.light-mode .title {
            color: #1a1a1a;
        }

        body.light-mode .upload-container {
            border-color: #ccc;
        }

        body.light-mode .upload-container:hover {
            background-color: #f8f9fa;
            border-color: #666;
        }

        body.light-mode .upload-icon,
        body.light-mode .upload-container p {
            color: #666;
        }

        body.light-mode .results {
            background-color: #f8f9fa;
        }

        body.light-mode .result-item {
            background: white;
        }

        body.light-mode .result-item h4 {
            color: #666;
        }

        body.light-mode .result-item p {
            color: #1a1a1a;
        }

        body.light-mode .timer {
            color: #666;
        }

        body.light-mode .error {
            background-color: #ffe6e6;
        }
    </style>
</head>

<body>
    <button class="mode-toggle" id="mode-toggle">
        <span class="icon sun">☀️</span>
        <span class="icon moon">🌙</span>
    </button>
    <div class="container">
        <h1 class="title">Product Scanner</h1>

        <div class="upload-container" id="upload-area">
            <div class="upload-icon">📁</div>
            <p>Click or drag and drop an image here</p>
            <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <div class="image-preview-container">
            <img id="image-preview">
        </div>

        <div class="buttons">
            <button class="btn btn-primary" id="process-btn" style="display: none;">Process Image</button>
            <button class="btn btn-secondary" id="reset-btn" style="display: none;">Reset</button>
        </div>

        <div class="processing">
            <div class="spinner"></div>
            <span class="timer">Processing: 0s</span>
        </div>

        <div class="error"></div>

        <div class="results">
            <h3>Extracted Information</h3>
            <div class="results-grid">
                <div class="result-item">
                    <h4>Batch Number</h4>
                    <p id="batch-no"></p>
                </div>
                <div class="result-item">
                    <h4>Manufacturing Date</h4>
                    <p id="mfg-date"></p>
                </div>
                <div class="result-item">
                    <h4>Expiry Date</h4>
                    <p id="exp-date"></p>
                </div>
                <div class="result-item">
                    <h4>MRP</h4>
                    <p id="mrp"></p>
                </div>
            </div>
        </div>
    </div>
    <footer style="text-align: center; margin-top: 2rem; font-size: 0.875rem; color: #666;">
        We use your image to enhance our service quality.
    </footer>
    <script>
        let cropper;
        let timer;
        let startTime;

        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const imagePreview = document.getElementById('image-preview');
        const previewContainer = document.querySelector('.image-preview-container');
        const processBtn = document.getElementById('process-btn');
        const resetBtn = document.getElementById('reset-btn');
        const processingDiv = document.querySelector('.processing');
        const timerSpan = document.querySelector('.timer');
        const resultsDiv = document.querySelector('.results');
        const errorDiv = document.querySelector('.error');

        let originalImageFile;

        // Upload handling
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#0066cc';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ccc';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ccc';
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }

            originalImageFile = file;

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
                processBtn.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';

                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(imagePreview, {
                    aspectRatio: NaN,
                    viewMode: 2,
                    background: false,
                    responsive: true,
                    ready() {
                        this.cropper.crop();
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        processBtn.addEventListener('click', async () => {
            if (!cropper) return;

            // Hide the upload area
            uploadArea.style.display = 'none';
            previewContainer.style.display = 'none';

            startTimer();
            processBtn.disabled = true;
            processingDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                const croppedCanvas = cropper.getCroppedCanvas();
                const croppedBlob = await new Promise(resolve => croppedCanvas.toBlob(resolve, 'image/jpeg'));
                const formData = new FormData();
                formData.append('image', originalImageFile);
                formData.append('cropped_image', croppedBlob, 'cropped-image.jpg');

                const response = await fetch('/process_image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Processing failed');

                const data = await response.json();
                console.log('Received data:', data); // Add this line for logging
                displayResults(data.extracted_info); // Ensure to pass the correct data
            } catch (error) {
                console.error('Error during processing:', error); // Add this line for logging
                showError('An error occurred while processing the image.');
            } finally {
                stopTimer();
                processBtn.disabled = false;
                processingDiv.style.display = 'none';
            }
        });

        resetBtn.addEventListener('click', () => {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            } else if (resultsDiv.style.display === 'block') {
                location.reload();
            } else {
                fileInput.value = '';
                imagePreview.src = '';
                previewContainer.style.display = 'none';
                processBtn.style.display = 'none';
                resetBtn.style.display = 'none';
                resultsDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                stopTimer();
            }
        });

        function startTimer() {
            startTime = Date.now();
            timer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                timerSpan.textContent = `Processing: ${elapsed}s`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timer);
        }

        function displayResults(data) {
            console.log('Displaying results:', data); // Add this line for logging
            document.getElementById('batch-no').textContent = data.BNo ? data.BNo.join(', ') : 'Not found';
            document.getElementById('mfg-date').textContent = data.MfgD ? data.MfgD.join(', ') : 'Not found';
            document.getElementById('exp-date').textContent = data.ExpD ? data.ExpD.join(', ') : 'Not found';
            document.getElementById('mrp').textContent = data.MRP ? data.MRP.join(', ') : 'Not found';
            resultsDiv.style.display = 'block';
        }

        function showError(message) {
            console.error('Error message:', message); // Add this line for logging
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        const modeToggle = document.getElementById('mode-toggle');
        const currentMode = localStorage.getItem('mode') || 'light';

        document.body.classList.add(`${currentMode}-mode`);
        if (currentMode === 'dark') {
            modeToggle.classList.add('dark');
        }

        modeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            modeToggle.classList.toggle('dark');

            const newMode = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            localStorage.setItem('mode', newMode);
        });
    </script>
</body>

</html>