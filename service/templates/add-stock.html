<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Stock Manually - Product Scanner by ayush1512</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f0f2f5;
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: clamp(1rem, 4vw, 2rem);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
        }

        .title {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 2rem;
            font-size: clamp(1.5rem, 4vw, 2rem);
            word-wrap: break-word;
        }

        .btn-primary {
            background-color: #0066cc;
            border-color: #0066cc;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0052a3;
            border-color: #0052a3;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.5rem;
        }

        .nav-item {
            list-style: none;
        }

        .nav-link {
            color: #6c757d;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem 0.25rem 0 0;
            transition: all 0.2s ease;
        }

        .nav-link:hover {
            color: #0066cc;
            background-color: #f8f9fa;
        }

        .nav-link.active {
            color: #0066cc;
            border-bottom: 2px solid #0066cc;
        }

        /* Input table styles */
        .stock-input-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .stock-input-table th {
            background-color: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: bold;
        }

        .stock-input-table td {
            padding: 0.5rem;
        }

        .stock-input-table input,
        .stock-input-table select {
            width: 100%;
            padding: 0.375rem 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .stock-input-table input:focus,
        .stock-input-table select:focus {
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        /* Error message style */
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Success message style */
        .success-message {
            color: #28a745;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Dark mode styles */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #fff;
            }

            .container {
                background: #2d2d2d;
            }

            .title {
                color: #fff;
            }

            .stock-input-table th {
                background-color: #363636;
                color: #fff;
            }

            .stock-input-table input,
            .stock-input-table select {
                background-color: #363636;
                color: #fff;
                border-color: #444;
            }

            .stock-input-table input:focus,
            .stock-input-table select:focus {
                border-color: #80bdff;
                box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            }
        }

        /* Light/Dark mode toggle styles */
        body.light-mode {
            background-color: #f0f2f5;
            color: #1a1a1a;
        }

        body.light-mode .container {
            background: white;
        }

        body.light-mode .title {
            color: #1a1a1a;
        }

        body.light-mode .stock-input-table th {
            background-color: #f8f9fa;
            color: #1a1a1a;
        }

        body.light-mode .stock-input-table input,
        body.light-mode .stock-input-table select {
            background-color: #fff;
            color: #1a1a1a;
            border-color: #ced4da;
        }

        body.dark-mode {
            background-color: #1a1a1a;
            color: #fff;
        }

        body.dark-mode .container {
            background: #2d2d2d;
        }

        body.dark-mode .title {
            color: #fff;
        }

        body.dark-mode .stock-input-table th {
            background-color: #363636;
            color: #fff;
        }

        body.dark-mode .stock-input-table input,
        body.dark-mode .stock-input-table select {
            background-color: #363636;
            color: #fff;
            border-color: #444;
        }

        /* Mode toggle button */
        .mode-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #0066cc;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mode-toggle.dark {
            background: #444;
        }

        .mode-toggle .icon {
            font-size: 1.5rem;
        }

        .mode-toggle .icon.sun {
            display: none;
        }

        .mode-toggle.dark .icon.sun {
            display: inline;
        }

        .mode-toggle.dark .icon.moon {
            display: none;
        }

        body.light-mode .mode-toggle .icon.sun {
            display: none;
        }

        body.light-mode .mode-toggle .icon.moon {
            display: inline;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            gap: 1rem;
        }

        .action-buttons button {
            padding: 0.5rem 1rem;
        }

        /* Row actions */
        .row-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin-right: 0.25rem;
        }

        /* Mobile responsive styles */
        @media screen and (max-width: 767px) {
            .container {
                padding: 0.75rem;
            }

            .stock-input-table {
                display: block;
                overflow-x: auto;
            }

            .action-buttons {
                flex-direction: column;
            }
        }

        /* jQuery UI Autocomplete styles */
        .ui-autocomplete {
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 5px 0;
        }

        .ui-menu-item {
            padding: 5px 10px;
            cursor: pointer;
        }

        .ui-menu-item:hover {
            background-color: #f0f0f0;
        }

        .ui-state-active,
        .ui-widget-content .ui-state-active {
            background-color: #0066cc;
            color: white;
            border: none;
            margin: 0;
        }

        /* Dark mode for autocomplete */
        body.dark-mode .ui-autocomplete {
            background-color: #363636;
            border-color: #444;
            color: #fff;
        }

        body.dark-mode .ui-menu-item:hover {
            background-color: #444;
        }

        body.dark-mode .ui-state-active,
        body.dark-mode .ui-widget-content .ui-state-active {
            background-color: #0066cc;
        }
    </style>
</head>

<body>
    <button class="mode-toggle" id="mode-toggle">
        <span class="icon sun">‚òÄÔ∏è</span>
        <span class="icon moon">üåô</span>
    </button>

    <div class="container">
        <h1 class="title">Add Stock Manually</h1>

        <div class="nav-container">
            <ul class="nav-tabs">
                <li class="nav-item">
                    <a href="/" class="nav-link">Product Scanner</a>
                </li>
                <li class="nav-item">
                    <a href="/stock" class="nav-link">Stock Inventory</a>
                </li>
                <li class="nav-item">
                    <a href="/add-stock" class="nav-link active">Add Stock</a>
                </li>
            </ul>
        </div>

        <div class="alert alert-info mb-4">
            Enter stock details below. You can add multiple items before submitting.
        </div>

        <div class="table-responsive">
            <table class="stock-input-table" id="stock-input-table">
                <thead>
                    <tr>
                        <th>Medicine Name*</th>
                        <th>Manufacturer</th>
                        <th>Category</th>
                        <th>Batch No*</th>
                        <th>Mfg Date (MM/YYYY)</th>
                        <th>Exp Date (MM/YYYY)*</th>
                        <th>MRP (‚Çπ)*</th>
                        <th>Quantity*</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="stock-input-body">
                    <tr class="stock-row">
                        <td><input type="text" class="medicine-name" required></td>
                        <td><input type="text" class="manufacturer"></td>
                        <td>
                            <select class="category">
                                <option value="Tablet">Tablet</option>
                                <option value="Capsule">Capsule</option>
                                <option value="Syrup">Syrup</option>
                                <option value="Injection">Injection</option>
                                <option value="Cream">Cream</option>
                                <option value="Drops">Drops</option>
                                <option value="Inhaler">Inhaler</option>
                                <option value="Powder">Powder</option>
                                <option value="Other">Other</option>
                            </select>
                        </td>
                        <td><input type="text" class="batch-no" required></td>
                        <td><input type="text" class="mfg-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}"></td>
                        <td><input type="text" class="exp-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}" required></td>
                        <td><input type="number" class="mrp" step="0.01" min="0" required></td>
                        <td><input type="number" class="quantity" min="0" required></td>
                        <td class="row-actions">
                            <button class="btn btn-sm btn-danger delete-row">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="action-buttons">
            <button id="add-row" class="btn btn-secondary">+ Add Another Item</button>
            <button id="save-all" class="btn btn-primary">Save All Items</button>
        </div>

        <div id="message-container" class="mt-3"></div>
    </div>

    <!-- Footer -->
    <footer style="text-align: center; margin-top: 2rem; font-size: 0.875rem; color: #666;">
        &copy; 2024 Product Scanner by ayush1512
    </footer>    <script>
        $(document).ready(function () {
            // Test API endpoint first
            console.log('Testing medicine search API...');
            $.ajax({
                url: '/medicine/search',
                method: 'GET',
                data: {
                    term: "para",
                    auto_enrich: true
                },
                success: function(data) {
                    console.log('API test successful:', data);
                },
                error: function(error) {
                    console.error('API test failed:', error);
                }
            });
            
            // Initialize mode from localStorage
            const currentMode = localStorage.getItem('mode') || 'light';
            document.body.classList.add(`${currentMode}-mode`);
            if (currentMode === 'dark') {
                document.getElementById('mode-toggle').classList.add('dark');
            }

            // Mode toggle
            $('#mode-toggle').on('click', function() {
                document.body.classList.toggle('dark-mode');
                document.body.classList.toggle('light-mode');
                this.classList.toggle('dark');

                const newMode = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
                localStorage.setItem('mode', newMode);
            });              // Initialize autocomplete on all medicine name fields (both existing and future)
            function initAutocomplete(element) {
                $(element).autocomplete({
                    source: function(request, response) {
                        console.log('Searching for:', request.term);
                        $.ajax({
                            url: `/medicine/search`,
                            method: 'GET',
                            data: {
                                term: request.term,
                                auto_enrich: true
                            },
                            dataType: "json",
                            success: function(data) {
                                console.log('Search results:', data);
                                response(data.map(function(medicine) {
                                    return {
                                        label: medicine.product_name + " - " + (medicine.product_manufactured || 'Unknown'),
                                        value: medicine.product_name,
                                        medicine: medicine
                                    };
                                }));
                            },
                            error: function(error) {
                                console.error('Autocomplete search failed:', error);
                                response([]);
                            }
                        });
                    },
                    minLength: 2,
                    delay: 300,
                    select: function(event, ui) {
                        console.log('Selected:', ui.item);
                        const medicine = ui.item.medicine;
                        const row = $(this).closest('tr');
                        
                        // Fill in other fields with medicine data
                        row.find('.manufacturer').val(medicine.product_manufactured || '');
                        row.find('.category').val(medicine.sub_category || 'Tablet');
                    },
                    open: function() {
                        console.log('Dropdown opened');
                    },
                    appendTo: "body",
                    position: { 
                        my: "left top", 
                        at: "left bottom", 
                        collision: "flip" 
                    },
                    classes: {
                        "ui-autocomplete": "highlight"
                    }
                });
            }
              // Initialize autocomplete for existing fields
            $('.medicine-name').each(function() {
                initAutocomplete(this);
            });
            
            // Set up event handler for future fields and force initialize for all inputs
            $(document).on('focus', '.medicine-name', function() {
                if (!$(this).data('ui-autocomplete')) {
                    console.log('Initializing autocomplete on focus');
                    initAutocomplete(this);
                }
            });
            
            // Force initialize for all medicine-name inputs now
            setTimeout(function() {
                console.log('Force initializing all medicine inputs');
                $('.medicine-name').each(function() {
                    if (!$(this).data('ui-autocomplete')) {
                        initAutocomplete(this);
                    }
                });
            }, 500);

            // Add new row
            $('#add-row').on('click', function() {
                const newRow = `
                    <tr class="stock-row">
                        <td><input type="text" class="medicine-name" required></td>
                        <td><input type="text" class="manufacturer"></td>
                        <td>
                            <select class="category">
                                <option value="Tablet">Tablet</option>
                                <option value="Capsule">Capsule</option>
                                <option value="Syrup">Syrup</option>
                                <option value="Injection">Injection</option>
                                <option value="Cream">Cream</option>
                                <option value="Drops">Drops</option>
                                <option value="Inhaler">Inhaler</option>
                                <option value="Powder">Powder</option>
                                <option value="Other">Other</option>
                            </select>
                        </td>
                        <td><input type="text" class="batch-no" required></td>
                        <td><input type="text" class="mfg-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}"></td>
                        <td><input type="text" class="exp-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}" required></td>
                        <td><input type="number" class="mrp" step="0.01" min="0" required></td>
                        <td><input type="number" class="quantity" min="0" required></td>
                        <td class="row-actions">
                            <button class="btn btn-sm btn-danger delete-row">Delete</button>
                        </td>
                    </tr>
                `;
                $('#stock-input-body').append(newRow);
            });

            // Delete row
            $(document).on('click', '.delete-row', function() {
                // Don't delete if it's the only row
                if ($('.stock-row').length > 1) {
                    $(this).closest('tr').remove();
                } else {
                    showMessage('Cannot delete the only row. Please clear the fields instead.', 'error');
                }
            });            // Note: Autocomplete for medicine name is already implemented above

            // Save all items
            $('#save-all').on('click', function() {
                if (!validateForm()) {
                    showMessage('Please fill in all required fields.', 'error');
                    return;
                }

                const stockItems = [];
                $('.stock-row').each(function() {
                    const row = $(this);
                    stockItems.push({
                        name: row.find('.medicine-name').val(),
                        manufacturer: row.find('.manufacturer').val(),
                        category: row.find('.category').val(),
                        batch: row.find('.batch-no').val(),
                        manufacturing_date: row.find('.mfg-date').val(),
                        expiry: row.find('.exp-date').val(),
                        price: parseFloat(row.find('.mrp').val()),
                        stock: parseInt(row.find('.quantity').val())
                    });
                });

                // Send data to server
                $.ajax({
                    url: '/stock/bulk-add',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ items: stockItems }),
                    success: function(response) {
                        showMessage('Stock items added successfully!', 'success');
                        // Clear form and keep only one empty row
                        $('#stock-input-body').html(`
                            <tr class="stock-row">
                                <td><input type="text" class="medicine-name" required></td>
                                <td><input type="text" class="manufacturer"></td>
                                <td>
                                    <select class="category">
                                        <option value="Tablet">Tablet</option>
                                        <option value="Capsule">Capsule</option>
                                        <option value="Syrup">Syrup</option>
                                        <option value="Injection">Injection</option>
                                        <option value="Cream">Cream</option>
                                        <option value="Drops">Drops</option>
                                        <option value="Inhaler">Inhaler</option>
                                        <option value="Powder">Powder</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </td>
                                <td><input type="text" class="batch-no" required></td>
                                <td><input type="text" class="mfg-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}"></td>
                                <td><input type="text" class="exp-date" placeholder="MM/YYYY" pattern="(0[1-9]|1[0-2])\/\d{4}" required></td>
                                <td><input type="number" class="mrp" step="0.01" min="0" required></td>
                                <td><input type="number" class="quantity" min="0" required></td>
                                <td class="row-actions">
                                    <button class="btn btn-sm btn-danger delete-row">Delete</button>
                                </td>
                            </tr>
                        `);
                    },
                    error: function(error) {
                        console.error('Error adding stock items:', error);
                        showMessage('Failed to add stock items. Please try again.', 'error');
                    }
                });            });
            
            function validateForm() {
                let valid = true;
                $('.stock-row').each(function() {
                    const row = $(this);
                    const requiredInputs = row.find('input[required]');
                    requiredInputs.each(function() {
                        if (!$(this).val()) {
                            $(this).addClass('is-invalid');
                            valid = false;
                        } else {
                            $(this).removeClass('is-invalid');
                        }
                    });

                    // Validate date formats
                    const expDate = row.find('.exp-date').val();
                    if (expDate && !/(0[1-9]|1[0-2])\/\d{4}/.test(expDate)) {
                        row.find('.exp-date').addClass('is-invalid');
                        valid = false;
                    }

                    const mfgDate = row.find('.mfg-date').val();
                    if (mfgDate && !/(0[1-9]|1[0-2])\/\d{4}/.test(mfgDate)) {
                        row.find('.mfg-date').addClass('is-invalid');
                        valid = false;
                    }
                });
                return valid;
            }

            function showMessage(message, type) {
                const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
                $('#message-container').html(`
                    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);
            }
        });
    </script>
</body>

</html>
